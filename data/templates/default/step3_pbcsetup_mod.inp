* GENERATED BY CHARMM-GUI (http://www.charmm-gui.org) v3.7 on Jan, 21. 2022. JOBID=4277418608
* SETUP PERIODIC BOUNDARY CONDITION 
* 

DIMENS CHSIZE 5000000 MAXRES 3000000

! Read topology and parameter files
stream toppar.str

!Read PSF and Coordinates 
open read unit 10 card name step1_pdbreader.psf
read psf  unit 10 card


stream step2_solvator.str

open read unit 10 card name step2_solvator.psf
read psf  unit 10 card

open read unit 10 card name step2_solvator.crd
read coor unit 10 card


!
! Setup PBC (Periodic Boundary Condition)
!

stream step2.1_waterbox.prm

COOR CONVERT ALIGNED SYMMETRIC @A @B @C @alpha @beta @gamma

open read unit 10 card name crystal_image.str
CRYSTAL DEFINE @XTLtype @A @B @C @alpha @beta @gamma
CRYSTAL READ UNIT 10 CARD

!Image centering by residue
IMAGE BYRESID XCEN @xcen YCEN @ycen ZCEN @zcen sele resname TIP3 end
IMAGE BYRESID XCEN @xcen YCEN @ycen ZCEN @zcen sele segid IONS end

!
! Nonbonded Options
!

system "python checkfft.py ?XTLA ?XTLB ?XTLC > checkfft.str"
stream checkfft.str


nbonds atom vatom vfswitch bycb -
       ctonnb 10.0 ctofnb 12.0 cutnb 16.0 cutim 16.0 -
       inbfrq -1 imgfrq -1 wmin 1.0 cdie eps 1.0 -
       ewald pmew fftx @fftx ffty @ffty fftz @fftz  kappa .34 spline order 6
energy

!
! cons fix all heavy atoms except generated water molecules and 
! short minimization
!

cons fix sele .not. ( hydrogen .or. segid SOLV .or. segid IONS ) end
cons harm force 0.1 sele segid IONS end

mini SD   nstep 50 nprint 5
mini ABNR nstep 50 nprint 5

cons fix sele none end


!
! Write coordinates and system information
!

open write unit 10 card name step3_pbcsetup.psf
write  psf unit 10 card

open write unit 10 card name step3_pbcsetup.oldpsf
write  psf unit 10 card oldpsf

open write unit 10 card name step3_pbcsetup.pdb
write coor unit 10 pdb  

open write unit 10 card name step3_pbcsetup.crd
write coor unit 10 card

open  write unit 90 card name step3_pbcsetup.str
write title unit 90
* set BoxType  = @BoxType
* set XTLtype  = @XTLtype
* set A = @A
* set B = @B
* set C = @C
* set Alpha = @Alpha
* set Beta  = @Beta
* set Gamma = @Gamma
* set fftx  = @fftx
* set ffty  = @ffty
* set fftz  = @fftz
* set xcen  = @xcen
* set ycen  = @ycen
* set zcen  = @zcen
*

!
! Translate coordinates to work with openMM and save them in the openmm folder
!

coor stat
calc xr = -1*?XMIN
calc yr = -1*?YMIN
calc zr = -1*?ZMIN

coor tran xdir @XR ydir @YR zdir @ZR

! Positional restraints for equilibration                                       
! from CG step4_equilibration.inp                                               
!
! MAY NEED MODIFICATION TO COVER THE ACTUAL SYSTEM                              
!
! Define BB and SC (and likely more in other systems)                           
! BB contains:                                                                  
! - selected heavy atoms, apparently the backbone of the protein (PROT)         
!   notably not; OT1,OT2,                                                       
! - selected heavy atoms in sugars (CARB) [complicated by "bonded" - pyranose?] 
! - all non-hydrogens in ligands or metals (HETE)                               
!                                                                               
! SC contains those heavy atoms not selected in BB, from PROT and CARB, notably:
! - side chain heavy atoms                                                      
                                                                                
define PROT sele ( segid PROA ) end                                             
define CARB sele none end                                                       
define HETE sele ( segid HET* ) end                                             
                                                                                
define BB   sele ( ( type C   .or. type O   .or. -                              
                     type N   .or. type CA  .or. -                              
                     type P   .or. type O1P .or. -                              
                     type O2P .or. type O5' .or. -                              
                     type C5' .or. type C4' .or. -                              
                     type C3' .or. type O3' ) .and. PROT ) .or. -               
                 ( ( type C+ .or. ( type O5 .and. .bonded. type C1 ) .or. -     
                   ( type O6 .and. .bonded. type C2 ) ) .and. CARB ) .or. -     
                 ( .not. hydrogen .and. HETE ) end                              
                                                                                
define SC   sele .not. BB .and. .not. hydrogen .and. ( PROT .or. CARB ) end     
                                                                                
! The following lines are kept for documenting the default restraints           
!cons harm force 1.0 sele BB end                                                
!cons harm force 0.1 sele SC end                                                
                                                                                
! Open output file and write the indexes of the selected residues iteratively   
! The loop structure is based on the CHARMM docs, and uses the selection        
! option .subset.                                                               
                                                                                
open write form name openmm/restraints/prot_pos.txt unit 30                     
echu 30                                                                         
                                                                                
define BB sele BB end                                                           
set bbnum ?nsel                                                                 
set I 0                                                                         
label bblist                                                                    
increment I by 1                                                                
define bbcur sele BB .subset. @I end                                            
calc bbommidx = ?selatom - 1                                                    
if @bbommidx .GE. 0 echo @bbommidx BB ! Avoids -1 BB if sele BB is empty        
if @I .LT. @bbnum goto bblist                                                   
                                                                                
define SC sele SC end                                                           
set scnum ?nsel                                                                 
set I 0                                                                         
label sclist                                                                    
increment I by 1                                                                
define sccur sele SC .subset. @I end                                            
calc scommidx = ?selatom - 1                                                    
if @scommidx .GE. 0 echo @scommidx SC ! Avoids -1 SC if sele SC is empty        
if @I .LT. @scnum goto sclist                                                   
echu                                                                            

! Write out PSF, CRD and PDB 

open write unit 10 card name openmm/step3_pbcsetup.psf
write  psf unit 10 card

open write unit 10 card name openmm/step3_pbcsetup.pdb
write coor unit 10 pdb  

open write unit 10 card name openmm/step3_pbcsetup.crd
write coor unit 10 card

stop
